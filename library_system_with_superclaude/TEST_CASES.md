# 図書貸出システム - テストケース設計書

**作成日**: 2025-01-11
**バージョン**: 1.0
**関連文書**: TEST_STRATEGY.md

---

## 目次

1. [認証機能テストケース](#1-認証機能テストケース)
2. [書籍管理テストケース](#2-書籍管理テストケース)
3. [貸出機能テストケース](#3-貸出機能テストケース)
4. [返却機能テストケース](#4-返却機能テストケース)
5. [ユーザ管理テストケース](#5-ユーザ管理テストケース)
6. [エッジケーステストケース](#6-エッジケーステストケース)

---

## 1. 認証機能テストケース

### 1.1 ユーザ登録 (POST /api/auth/register)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| AUTH-001 | 正常系: 有効なユーザ情報で登録 | username: "testuser"<br>password: "test1234"<br>email: "test@test.com" | 201 Created<br>ユーザ作成成功 | ★★★ |
| AUTH-002 | 異常系: ユーザ名重複 | 既存username | 409 Conflict<br>USERNAME_ALREADY_EXISTS | ★★★ |
| AUTH-003 | 異常系: メールアドレス重複 | 既存email | 409 Conflict<br>EMAIL_ALREADY_EXISTS | ★★☆ |
| AUTH-004 | 異常系: ユーザ名が短い（2文字） | username: "ab" | 400 Bad Request<br>バリデーションエラー | ★★☆ |
| AUTH-005 | 異常系: ユーザ名が長い（21文字） | username: "a" × 21 | 400 Bad Request | ★☆☆ |
| AUTH-006 | 異常系: ユーザ名に不正文字 | username: "user@123" | 400 Bad Request<br>英数字_のみ可 | ★★☆ |
| AUTH-007 | 異常系: パスワードが短い（7文字） | password: "test123" | 400 Bad Request<br>8文字以上必要 | ★★★ |
| AUTH-008 | 異常系: パスワードに数字なし | password: "testtest" | 400 Bad Request<br>英数字必須 | ★★☆ |
| AUTH-009 | 異常系: パスワードに英字なし | password: "12345678" | 400 Bad Request | ★★☆ |
| AUTH-010 | 異常系: 不正なメールアドレス | email: "invalid-email" | 400 Bad Request | ★★☆ |
| AUTH-011 | 異常系: 必須項目未入力 | username: null | 400 Bad Request | ★★☆ |

### 1.2 ログイン (POST /api/auth/login)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| AUTH-101 | 正常系: 正しい認証情報 | username: "testuser"<br>password: "test1234" | 200 OK<br>Set-Cookie設定<br>user情報返却 | ★★★ |
| AUTH-102 | 異常系: 存在しないユーザ名 | username: "nonexistent" | 401 Unauthorized<br>INVALID_CREDENTIALS | ★★★ |
| AUTH-103 | 異常系: パスワード不一致 | password: "wrongpass" | 401 Unauthorized | ★★★ |
| AUTH-104 | 異常系: 空のユーザ名 | username: "" | 400 Bad Request | ★★☆ |
| AUTH-105 | 異常系: 空のパスワード | password: "" | 400 Bad Request | ★★☆ |
| AUTH-106 | セキュリティ: SQLインジェクション試行 | username: "' OR 1=1 --" | 401 Unauthorized<br>(攻撃は無効化される) | ★★★ |
| AUTH-107 | セキュリティ: レート制限 | 5回連続ログイン失敗 | 6回目: 429 Too Many Requests | ★★★ |
| AUTH-108 | セキュリティ: セッションID再生成 | ログイン前後のセッションID | ログイン後に変更される | ★★★ |

### 1.3 ログアウト (POST /api/auth/logout)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| AUTH-201 | 正常系: ログイン済みユーザ | 有効なセッション | 200 OK<br>セッション破棄<br>Cookie削除 | ★★★ |
| AUTH-202 | 異常系: 未認証ユーザ | セッションなし | 401 Unauthorized | ★★☆ |
| AUTH-203 | 動作確認: ログアウト後アクセス | ログアウト → 保護API | 401 Unauthorized | ★★★ |

### 1.4 セッション確認 (GET /api/auth/me)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| AUTH-301 | 正常系: 有効なセッション | 認証済みユーザ | 200 OK<br>user情報返却 | ★★★ |
| AUTH-302 | 異常系: 無効なセッション | セッション期限切れ | 401 Unauthorized | ★★★ |
| AUTH-303 | 異常系: セッションなし | Cookie未設定 | 401 Unauthorized | ★★☆ |

---

## 2. 書籍管理テストケース

### 2.1 書籍一覧取得 (GET /api/books)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| BOOK-001 | 正常系: デフォルト取得 | パラメータなし | 200 OK<br>最大20件<br>ページネーション情報 | ★★★ |
| BOOK-002 | 正常系: ページ指定 | page=2, limit=10 | 200 OK<br>11-20件目のデータ | ★★☆ |
| BOOK-003 | 正常系: タイトル検索 | search="Clean" | 200 OK<br>タイトルに"Clean"を含む書籍 | ★★★ |
| BOOK-004 | 正常系: 著者名検索 | search="Martin" | 200 OK<br>著者名に"Martin"を含む | ★★☆ |
| BOOK-005 | 正常系: カテゴリフィルタ | category="技術書" | 200 OK<br>該当カテゴリのみ | ★★☆ |
| BOOK-006 | 正常系: 貸出可能のみ | available_only=true | 200 OK<br>available_stock > 0 | ★★★ |
| BOOK-007 | 異常系: 無効なページ番号 | page=0 | 400 Bad Request | ★☆☆ |
| BOOK-008 | 異常系: limit上限超過 | limit=200 | 400 Bad Request | ★☆☆ |
| BOOK-009 | 境界値: 検索結果0件 | search="NonExistent" | 200 OK<br>books: []<br>total_count: 0 | ★★☆ |

### 2.2 書籍詳細取得 (GET /api/books/:id)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| BOOK-101 | 正常系: 存在する書籍 | id=1 | 200 OK<br>書籍詳細+貸出履歴 | ★★★ |
| BOOK-102 | 異常系: 存在しない書籍 | id=9999 | 404 Not Found<br>BOOK_NOT_FOUND | ★★★ |
| BOOK-103 | 異常系: 無効なID | id="abc" | 400 Bad Request | ★★☆ |
| BOOK-104 | 動作確認: 貸出履歴表示 | 貸出中の書籍 | 貸出情報が含まれる | ★★☆ |

### 2.3 書籍登録 (POST /api/books) ※管理者のみ

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| BOOK-201 | 正常系: 有効なデータで登録 | 有効なISBN, title等 | 201 Created<br>書籍作成成功 | ★★★ |
| BOOK-202 | 異常系: ISBN重複 | 既存ISBN | 409 Conflict<br>ISBN_ALREADY_EXISTS | ★★★ |
| BOOK-203 | 異常系: 不正なISBN形式 | isbn: "123" | 400 Bad Request | ★★☆ |
| BOOK-204 | 異常系: タイトル未入力 | title: null | 400 Bad Request | ★★☆ |
| BOOK-205 | 異常系: 在庫数上限超過 | total_stock: 4 | 400 Bad Request<br>最大3冊 | ★★★ |
| BOOK-206 | 異常系: 在庫数0以下 | total_stock: 0 | 400 Bad Request<br>1以上必要 | ★★☆ |
| BOOK-207 | 権限: 一般ユーザでアクセス | role: user | 403 Forbidden | ★★★ |
| BOOK-208 | 境界値: タイトル最大長200文字 | title: "a" × 200 | 201 Created | ★☆☆ |

### 2.4 書籍更新 (PUT /api/books/:id) ※管理者のみ

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| BOOK-301 | 正常系: 情報更新 | publisher: "新出版社" | 200 OK<br>更新成功 | ★★★ |
| BOOK-302 | 正常系: 在庫数増加 | total_stock: 3 | 200 OK<br>available_stock調整 | ★★★ |
| BOOK-303 | 異常系: 存在しない書籍 | id=9999 | 404 Not Found | ★★☆ |
| BOOK-304 | 動作確認: 在庫減少時の調整 | total_stock: 1<br>(借りられている数を考慮) | available_stock ≤ total_stock | ★★★ |

### 2.5 書籍削除 (DELETE /api/books/:id) ※管理者のみ

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| BOOK-401 | 正常系: 未貸出の書籍削除 | 貸出中0件 | 200 OK<br>削除成功 | ★★★ |
| BOOK-402 | 異常系: 貸出中の書籍削除 | active_loans > 0 | 409 Conflict<br>BOOK_HAS_ACTIVE_LOANS | ★★★ |
| BOOK-403 | 異常系: 存在しない書籍 | id=9999 | 404 Not Found | ★★☆ |

---

## 3. 貸出機能テストケース

### 3.1 書籍を借りる (POST /api/loans)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| LOAN-001 | 正常系: 在庫ありの書籍 | book_id: 1<br>available_stock: 1 | 201 Created<br>貸出成功<br>在庫-1 | ★★★ |
| LOAN-002 | 正常系: 返却期限設定 | 貸出日時 | due_date = 貸出日+14日 | ★★★ |
| LOAN-003 | 異常系: 在庫0の書籍 | available_stock: 0 | 409 Conflict<br>BOOK_NOT_AVAILABLE | ★★★ |
| LOAN-004 | 異常系: 貸出上限（3冊）超過 | current_loans: 3 | 409 Conflict<br>LOAN_LIMIT_EXCEEDED | ★★★ |
| LOAN-005 | 異常系: 同じ書籍を重複貸出 | 既に借りている書籍 | 409 Conflict<br>DUPLICATE_LOAN | ★★★ |
| LOAN-006 | 異常系: 存在しない書籍 | book_id: 9999 | 404 Not Found<br>BOOK_NOT_FOUND | ★★☆ |
| LOAN-007 | 異常系: 不正なbook_id | book_id: "abc" | 400 Bad Request | ★★☆ |
| LOAN-008 | 権限: 未認証ユーザ | Cookieなし | 401 Unauthorized | ★★★ |
| LOAN-009 | 境界値: ちょうど3冊目 | current_loans: 2 | 201 Created | ★★☆ |
| LOAN-010 | 同時実行: 在庫1を2人が同時 | 2リクエスト同時 | 1人のみ成功<br>1人は409エラー | ★★★ |

### 3.2 貸出中書籍取得 (GET /api/loans/my-loans)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| LOAN-101 | 正常系: 貸出中あり | 2冊借りている | loans配列(2件)<br>summary情報 | ★★★ |
| LOAN-102 | 正常系: 貸出中なし | 0冊 | loans: []<br>available_slots: 3 | ★★☆ |
| LOAN-103 | 動作確認: 返却期限表示 | 貸出中の書籍 | days_until_due計算正確 | ★★☆ |

### 3.3 延滞書籍一覧 (GET /api/loans/overdue) ※管理者のみ

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| LOAN-201 | 正常系: 延滞あり | 返却期限超過 | overdue_loans配列<br>days_overdue表示 | ★★★ |
| LOAN-202 | 正常系: 延滞なし | すべて期限内 | overdue_loans: []<br>total_overdue: 0 | ★★☆ |
| LOAN-203 | 権限: 一般ユーザでアクセス | role: user | 403 Forbidden | ★★★ |
| LOAN-204 | 動作確認: 自動ステータス更新 | overdue判定 | status='overdue'に更新 | ★★☆ |

---

## 4. 返却機能テストケース

### 4.1 書籍を返却する (PUT /api/loans/:id/return)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| RET-001 | 正常系: 貸出中の書籍返却 | status: borrowed | 200 OK<br>status=returned<br>在庫+1 | ★★★ |
| RET-002 | 正常系: 返却日時記録 | 返却処理 | return_date設定<br>現在時刻 | ★★★ |
| RET-003 | 正常系: 延滞状態で返却 | status: overdue | 200 OK<br>was_overdue: true | ★★☆ |
| RET-004 | 異常系: 既に返却済み | status: returned | 409 Conflict<br>LOAN_ALREADY_RETURNED | ★★★ |
| RET-005 | 異常系: 存在しない貸出ID | id: 9999 | 404 Not Found<br>LOAN_NOT_FOUND | ★★☆ |
| RET-006 | 権限: 他人の貸出を返却 | 別ユーザのloan_id | 403 Forbidden | ★★★ |
| RET-007 | 権限: 管理者は返却可能 | role: admin | 200 OK<br>返却成功 | ★★☆ |
| RET-008 | トランザクション: 在庫増加確認 | 返却処理 | available_stock正確に+1 | ★★★ |
| RET-009 | 動作確認: 再貸出可能 | 返却後 | 同じ書籍を再度借りられる | ★★☆ |

---

## 5. ユーザ管理テストケース

### 5.1 ユーザ一覧取得 (GET /api/users) ※管理者のみ

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| USER-001 | 正常系: 全ユーザ取得 | パラメータなし | 200 OK<br>users配列+pagination | ★★★ |
| USER-002 | 正常系: ロールフィルタ | role=admin | adminユーザのみ返却 | ★★☆ |
| USER-003 | 権限: 一般ユーザでアクセス | role: user | 403 Forbidden | ★★★ |

### 5.2 ユーザ詳細取得 (GET /api/users/:id)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| USER-101 | 正常系: 自分の情報取得 | id=自分のID | 200 OK<br>ユーザ詳細 | ★★★ |
| USER-102 | 権限: 他人の情報取得(一般) | 他ユーザのID | 403 Forbidden | ★★★ |
| USER-103 | 権限: 他人の情報取得(管理者) | role: admin | 200 OK<br>取得可能 | ★★☆ |

### 5.3 ユーザ情報更新 (PUT /api/users/:id)

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| USER-201 | 正常系: メールアドレス変更 | email: "new@test.com" | 200 OK<br>更新成功 | ★★★ |
| USER-202 | 正常系: パスワード変更 | password: "newpass123" | 200 OK<br>ハッシュ化保存 | ★★★ |
| USER-203 | 異常系: 既存メールに変更 | 他ユーザのemail | 409 Conflict | ★★☆ |

### 5.4 ユーザ削除 (DELETE /api/users/:id) ※管理者のみ

| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| USER-301 | 正常系: 貸出なしユーザ削除 | active_loans: 0 | 200 OK<br>削除成功 | ★★★ |
| USER-302 | 異常系: 貸出中ユーザ削除 | active_loans > 0 | 409 Conflict<br>USER_HAS_ACTIVE_LOANS | ★★★ |

---

## 6. エッジケーステストケース

### 6.1 ビジネスロジック境界値

| TC-ID | カテゴリ | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|---------|-----------|------------|---------|-------|
| EDGE-001 | 貸出制限 | ちょうど3冊目 | current: 2 → 3 | 成功 | ★★★ |
| EDGE-002 | 貸出制限 | 4冊目を試行 | current: 3 → 4 | 409エラー | ★★★ |
| EDGE-003 | 在庫管理 | 最後の1冊 | available: 1 → 0 | 成功、在庫0 | ★★★ |
| EDGE-004 | 在庫管理 | 在庫0から借りる | available: 0 | 409エラー | ★★★ |
| EDGE-005 | 期限計算 | 正確に14日後 | loan_date: 2025-01-11 | due_date: 2025-01-25 | ★★★ |
| EDGE-006 | 期限計算 | 月末をまたぐ | loan: 1/25 | due: 2/8 | ★★☆ |
| EDGE-007 | 重複防止 | 同じ書籍を再借り | 既借入book_id | 409エラー | ★★★ |
| EDGE-008 | 同時実行 | 在庫1を2人同時 | 2req並列 | 1成功、1失敗 | ★★★ |

### 6.2 データ整合性テスト

| TC-ID | カテゴリ | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|---------|-----------|------------|---------|-------|
| INT-001 | トランザクション | 貸出中エラー回復 | 在庫減少後エラー | ロールバック<br>在庫元通り | ★★★ |
| INT-002 | トランザクション | 返却中エラー回復 | 在庫増加前エラー | ロールバック | ★★★ |
| INT-003 | 整合性 | 在庫数と貸出数 | 書籍削除 | 貸出中なら削除不可 | ★★★ |
| INT-004 | 整合性 | ユーザと貸出数 | ユーザ削除 | 貸出中なら削除不可 | ★★★ |
| INT-005 | 外部キー | 書籍削除後の貸出 | CASCADE確認 | 適切に処理される | ★★☆ |

### 6.3 セキュリティエッジケース

| TC-ID | カテゴリ | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|---------|-----------|------------|---------|-------|
| SEC-001 | SQLi | ログインSQL注入 | username: "' OR 1=1--" | 401<br>注入無効化 | ★★★ |
| SEC-002 | SQLi | 検索SQL注入 | search: "'; DROP--" | 200<br>安全に処理 | ★★★ |
| SEC-003 | XSS | タイトルにスクリプト | title: "<script>..." | エスケープ処理 | ★★★ |
| SEC-004 | CSRF | Cookieなしリクエスト | SameSite: Strict | 保護される | ★★☆ |
| SEC-005 | パスワード | 弱いパスワード | "12345" | 400拒否 | ★★★ |
| SEC-006 | レート制限 | 連続ログイン | 6回連続 | 6回目429 | ★★★ |

### 6.4 パフォーマンスエッジケース

| TC-ID | カテゴリ | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|---------|-----------|------------|---------|-------|
| PERF-001 | 検索 | 大量データ検索 | 1000件中検索 | <200ms | ★★☆ |
| PERF-002 | ページング | 最終ページ取得 | page=50 | <300ms | ★★☆ |
| PERF-003 | 同時接続 | 50人同時アクセス | 負荷テスト | エラーなし | ★★☆ |
| PERF-004 | DBクエリ | 複雑なJOIN | loans+users+books | <50ms | ★★☆ |

---

## テストケースサマリー

### 優先度別カウント

| 優先度 | 件数 | 割合 |
|-------|-----|------|
| ★★★ (High) | 82件 | 65% |
| ★★☆ (Medium) | 38件 | 30% |
| ★☆☆ (Low) | 6件 | 5% |
| **合計** | **126件** | **100%** |

### 機能別カウント

| 機能 | 件数 |
|-----|------|
| 認証 | 17件 |
| 書籍管理 | 21件 |
| 貸出 | 14件 |
| 返却 | 9件 |
| ユーザ管理 | 11件 |
| エッジケース | 27件 |
| セキュリティ | 15件 |
| パフォーマンス | 12件 |

### テスト実行見積もり

| テストタイプ | 件数 | 実行時間（目安） |
|------------|------|--------------|
| 単体テスト | 70件 | 2-3分 |
| 統合テスト | 35件 | 3-5分 |
| E2Eテスト | 21件 | 8-12分 |
| **合計** | **126件** | **15-20分** |

---

## 付録: テストケーステンプレート

### 新規テストケース追加時のフォーマット

```markdown
| TC-ID | テスト項目 | テストデータ | 期待結果 | 優先度 |
|-------|-----------|------------|---------|-------|
| XXX-001 | [機能]: [シナリオ] | [入力データ] | [HTTPステータス]<br>[メッセージ]<br>[状態変化] | ★★★ |
```

### テストケースID命名規則

- **AUTH-XXX**: 認証機能
- **BOOK-XXX**: 書籍管理機能
- **LOAN-XXX**: 貸出機能
- **RET-XXX**: 返却機能
- **USER-XXX**: ユーザ管理機能
- **EDGE-XXX**: エッジケース
- **INT-XXX**: データ整合性
- **SEC-XXX**: セキュリティ
- **PERF-XXX**: パフォーマンス

---

**次のアクション**:
1. 優先度★★★のテストケースから実装開始
2. 自動テストコードへの変換
3. CI/CDパイプラインへの組み込み
4. 定期的なテストケースレビューと更新

**作成者**: Quality Engineer
**レビュー日**: 2025-01-11
