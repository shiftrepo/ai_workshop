# Docker Compose configuration for Log Collector Tool - Docker Hub Ready
# Creates 3 log server containers with SSH access and dynamic log generation

version: '3.8'

services:
  # Log Server 1
  log-server1:
    image: ${DOCKER_IMAGE:-log-collector-tool:latest}
    container_name: log-server1-issue15
    hostname: log-server1
    ports:
      - "${SSH_PORT_1:-5001}:22"  # SSH access mapped to configurable port
    environment:
      - CONTINUOUS_LOGS=${CONTINUOUS_LOGS:-true}
      - SSH_USER=${SSH_USER:-logcollector}
      - LOG_SERVER_ID=server1
      - LOG_INTERVAL=${LOG_INTERVAL:-30}
    volumes:
      - log-server1-data:/var/log/app
      - log-server1-tmp:/tmp/logs
    restart: unless-stopped
    networks:
      - log-collection-network
    healthcheck:
      test: ["CMD-SHELL", "ls /var/log/app && pgrep sshd"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Log Server 2
  log-server2:
    image: ${DOCKER_IMAGE:-log-collector-tool:latest}
    container_name: log-server2-issue15
    hostname: log-server2
    ports:
      - "${SSH_PORT_2:-5002}:22"  # SSH access mapped to configurable port
    environment:
      - CONTINUOUS_LOGS=${CONTINUOUS_LOGS:-true}
      - SSH_USER=${SSH_USER:-logcollector}
      - LOG_SERVER_ID=server2
      - LOG_INTERVAL=${LOG_INTERVAL:-30}
    volumes:
      - log-server2-data:/var/log/app
      - log-server2-tmp:/tmp/logs
    restart: unless-stopped
    networks:
      - log-collection-network
    healthcheck:
      test: ["CMD-SHELL", "ls /var/log/app && pgrep sshd"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Log Server 3
  log-server3:
    image: ${DOCKER_IMAGE:-log-collector-tool:latest}
    container_name: log-server3-issue15
    hostname: log-server3
    ports:
      - "${SSH_PORT_3:-5003}:22"  # SSH access mapped to configurable port
    environment:
      - CONTINUOUS_LOGS=${CONTINUOUS_LOGS:-true}
      - SSH_USER=${SSH_USER:-logcollector}
      - LOG_SERVER_ID=server3
      - LOG_INTERVAL=${LOG_INTERVAL:-30}
    volumes:
      - log-server3-data:/var/log/app
      - log-server3-tmp:/tmp/logs
    restart: unless-stopped
    networks:
      - log-collection-network
    healthcheck:
      test: ["CMD-SHELL", "ls /var/log/app && pgrep sshd"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Log Collection Client (for testing the skill)
  log-client:
    image: ${DOCKER_IMAGE:-log-collector-tool:latest}
    container_name: log-client-issue15
    hostname: log-client
    environment:
      - SSH_HOST_1=${LOG_CLIENT_HOST_1:-log-server1}
      - SSH_HOST_2=${LOG_CLIENT_HOST_2:-log-server2}
      - SSH_HOST_3=${LOG_CLIENT_HOST_3:-log-server3}
      - SSH_PORT_1=22
      - SSH_PORT_2=22
      - SSH_PORT_3=22
      - SSH_USER=${SSH_USER:-logcollector}
      - INPUT_FOLDER=./examples
      - OUTPUT_FOLDER=./output
      - SSH_KEY_PATH=/app/.ssh/container_key  # Use dynamically generated key
      - LOG_PATTERN_FILE=./examples/log-patterns.json
    volumes:
      - client-output:/app/output
      - client-examples:/app/examples
    working_dir: /app
    networks:
      - log-collection-network
    depends_on:
      - log-server1
      - log-server2
      - log-server3
    command: ["tail", "-f", "/dev/null"]  # Keep client container running for manual testing

# Named volumes for persistent data
volumes:
  log-server1-data:
    driver: local
  log-server1-tmp:
    driver: local
  log-server2-data:
    driver: local
  log-server2-tmp:
    driver: local
  log-server3-data:
    driver: local
  log-server3-tmp:
    driver: local
  client-output:
    driver: local
  client-examples:
    driver: local

# Network for inter-container communication
networks:
  log-collection-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16