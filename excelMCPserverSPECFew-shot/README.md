# ディレクトリ比較ツール - Issue #7 実装記録

## プロジェクト概要

2つのディレクトリを比較し、Linux の sdiff コマンドのように並列表示する Excel ファイルを生成するツールです。

## Issue #7 要件分析

### 主要機能
- 2つのディレクトリのノード情報（ファイル、ディレクトリ、シンボリックリンク）を比較
- Excel上に左右並列で情報を表示
- 中央列に差分の有無を表示
- Linux の sdiff 形式に類似した出力

### 技術的制約
1. **実行環境**
   - サーバ側: Linux（オンプレミス、インターネット不可）
   - クライアント側: Windows/Mac（Node.js実行可能、npm アクセス可能）

2. **使用可能なコマンド**
   - `ls` コマンド（日時フォーマット指定）
   - チェックサム取得コマンド（`md5sum`, `sha256sum` 等）
   - Node.js 標準機能のみ

3. **情報取得の原則**
   - Linuxコマンドの出力は加工・変換禁止
   - 文字列として項目ごとに切り取り使用
   - パーミッション、ユーザ、グループはID変換せず文字列のまま使用
   - `ls` の出力そのままを比較対象とする

### 出力要件

#### Excel列構成
**左側（フォルダ1）:**
- A列: ノード名
- B列: フルパス
- C列: 権限（パーミッション）
- D列: オーナー
- E列: 更新日時
- F列: チェックサム

**中央:**
- G列: 差分ステータス（差分/一致/フォルダ1のみ/フォルダ2のみ）

**右側（フォルダ2）:**
- H列以降: フォルダ1と同じ列構成

#### 追加要件
- フィルタ用の列を追加（差分種別でフィルタリング可能に）
- 色分けによる視覚化
  - 差分あり: ピンク/赤系
  - 片方のみ存在: 青/紫系
  - ヘッダー: 緑系
- フルパスと親ディレクトリを列として追加
- タイトル行: 「フォルダ比較統合ビュー（sdiff形式）」

### ディレクトリ構成
```
project/
├── server/          # サーバ側実行資材（Linux用）
│   └── collect.sh   # 情報収集スクリプト
├── client/          # クライアント側実行資材（Node.js）
│   ├── compare.js   # 比較・Excel生成スクリプト
│   └── package.json
└── setup.sh         # セットアップスクリプト
```

## 実装計画

### Phase 1: サーバ側スクリプト（Linux）
1. `ls` コマンドで詳細情報を取得
   - `-l` オプションで詳細表示
   - `--time-style=full-iso` で完全な日時フォーマット
   - `-A` で隠しファイルを含む（`.` と `..` を除く）
   - `-R` で再帰的に取得
2. シンボリックリンクの検出（`-l` の出力から判定）
3. ファイルのチェックサム取得（`md5sum` または `sha256sum`）
4. 結果をJSON形式で出力

### Phase 2: クライアント側スクリプト（Node.js）
1. サーバから取得したJSONファイルを読み込み
2. 2つのディレクトリ情報を比較
   - ノード名でマッチング
   - パス構造を考慮
3. 差分の判定
   - 存在チェック
   - ファイルタイプチェック
   - チェックサム比較
   - パーミッション比較
   - オーナー/グループ比較
   - 更新日時比較
4. Excel ファイル生成
   - `exceljs` ライブラリを使用
   - 色分け適用
   - フィルタ機能追加

### Phase 3: セットアップとテスト
1. セットアップスクリプトの作成
2. test_folder1 と test_folder2 を使用した動作確認
3. ドキュメント整備

## 実装履歴

### 2025-09-30

#### 要件分析・計画策定
- Issue #7 の内容確認
- 添付画像（出力イメージ）の分析
- 要件分析と実装計画の策定

#### 実装完了
1. **サーバ側スクリプト（server/collect.sh）**
   - `ls -lAR --time-style=full-iso` でディレクトリ情報を再帰的に取得
   - `md5sum` でファイルのチェックサム計算
   - JSON形式で出力（パス、権限、オーナー、グループ、サイズ、日時、チェックサム等）
   - シンボリックリンクのリンク先も記録

2. **クライアント側スクリプト（client/compare.js）**
   - JSONファイルを読み込み、2つのディレクトリ情報を比較
   - ノードごとに差分判定（存在、タイプ、パーミッション、オーナー、グループ、サイズ、日時、チェックサム）
   - ExcelJS ライブラリを使用してExcelファイルを生成
   - sdiff形式の並列表示レイアウト
   - 色分け機能（差分=ピンク、片方のみ=青/紫）
   - 差分箇所を赤文字で強調
   - フィルタ列を追加

3. **セットアップスクリプト（setup.sh）**
   - 環境チェック（Node.js, npm, ls, md5sum）
   - クライアント側依存関係のインストール（npm install）
   - サーバ側スクリプトに実行権限付与

#### 動作確認
- test_folder1 と test_folder2 のサンプルデータを作成
  - 通常ファイル、ディレクトリ、シンボリックリンク、バイナリファイル、実行ファイル等
  - 意図的に差分を作成（内容変更、日時変更、片方のみ存在）
- 情報収集スクリプト実行: 21ノード（folder1）、19ノード（folder2）を収集
- 比較スクリプト実行: 23エントリの比較結果をExcelファイルに出力
  - 一致: 0
  - 差分: 17
  - フォルダ1のみ: 4
  - フォルダ2のみ: 2

#### 成果物
- `server/collect.sh`: Linux上で実行する情報収集スクリプト
- `client/compare.js`: Node.jsで実行する比較・Excel生成スクリプト
- `client/package.json`: 依存関係定義
- `setup.sh`: 環境セットアップスクリプト
- `client/comparison.xlsx`: 生成されたExcelファイル（サンプル）

## 使用方法

### 1. セットアップ（初回のみ）
```bash
bash setup.sh
```

### 2. サーバ側での情報収集（Linux）
```bash
# サーバにcollect.shを配置後
cd server

# 基本的な使い方（outputディレクトリに自動保存）
./collect.sh /path/to/folder1
./collect.sh /path/to/folder2

# または、出力先を明示的に指定
./collect.sh /path/to/folder1 ../output/folder1.json
./collect.sh /path/to/folder2 ../output/folder2.json

# 生成されたJSONファイルをクライアントに転送
```

**注意**: 出力ファイルは対象ディレクトリ内には作成できません。デフォルトでは `../output/` ディレクトリに保存されます。

### 3. クライアント側での比較・Excel生成
```bash
cd client

# 基本的な使い方（outputディレクトリに自動保存）
node compare.js ../output/folder1.json ../output/folder2.json

# または、出力先を明示的に指定
node compare.js ../output/folder1.json ../output/folder2.json ../output/comparison.xlsx
```

### 4. 結果確認
`output/comparison.xlsx` をExcelで開いて確認します。

## Excelファイルの見方

- **タイトル行**: フォルダ比較統合ビュー（sdiff形式）
- **フォルダ名行**: 比較対象の2つのフォルダ名
- **ヘッダー行**: 各列の項目名（緑色）
- **データ行**: 各ノードの比較結果
  - 無色: 完全一致
  - ピンク: 差分あり（赤文字で差分箇所を強調）
  - 青: フォルダ1のみ存在
  - 紫: フォルダ2のみ存在
- **フィルタ列**: 差分種別（identical/different/only_in_1/only_in_2）でフィルタリング可能

## 技術仕様

- **サーバ側**: Bash, ls, md5sum
- **クライアント側**: Node.js v14以上, ExcelJS
- **対応ファイルタイプ**: 通常ファイル、ディレクトリ、シンボリックリンク
- **チェックサム**: MD5（ファイルのみ）
- **日時フォーマット**: ISO 8601 完全形式

## 制限事項

- サーバ側はインターネット接続不要（オンプレミス対応）
- クライアント側は初回セットアップ時のみnpmアクセスが必要
- 大量のファイル（数万件以上）の場合、処理に時間がかかる可能性あり
- Windows環境での情報収集には Git Bash 等の Unix互換環境が必要
