%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#ffffff',
    'primaryTextColor': '#000000',
    'primaryBorderColor': '#000000',
    'lineColor': '#000000',
    'signalColor': '#000000',
    'signalTextColor': '#000000',
    'noteBkgColor': '#ffffff',
    'noteTextColor': '#000000',
    'noteBorderColor': '#000000',
    'actorBorder': '#000000',
    'actorTextColor': '#000000',
    'sequenceNumberColor': '#ffffff',
    'sequenceNumberBkgColor': '#000000'
  }
}}%%

sequenceDiagram
    autonumber

    %% --- 登場人物（アクター）の宣言 ---
    actor User as ユーザ
    participant ClaudeCode as Claude Code
    participant SubAgent as サブエージェント
    participant MemoryMCP as Memory MCP
    participant Skill as Skill
    participant MCP as 汎用MCP
    participant LLM as LLM

    %% --- 冒頭の説明ブロック ---
    note over User, LLM: 【アクター定義と役割詳細】<br><br>1. Claude Code (アプリ本体):<br>ユーザとシステムの仲介役。全体の進行管理を行う。<br><br>2. サブエージェント (専門領域定義):<br>LLMではない。特定の専門分野（DB, クラウド等）に関する「思考の型」や「コンテキスト」を定義するロジック。<br>LLMの思考を特定の領域に方向づけるために使用される。<br><br>3. Memory MCP (記憶・検索DB):<br>LLMではない。プロジェクト固有のルール（AWSキーの扱い等）を蓄積したデータベース。<br>LLMが思考する前に、ベクトル検索や文字列検索などで関連ルールをコンテキストに注入する。<br><br>4. Skill (固定化プロセス):<br>LLMの判断揺らぎやミスを防ぐために定義された「標準手順書」。<br>プロセスを固定化し、最短ルートでMCPを利用させる。<br><br>5. 汎用MCP (実働ツール):<br>外部システム（AWS, Git, ファイルシステム等）を実際に操作するためのAPI。<br><br>6. LLM (AIの頭脳):<br>システム内で唯一の「思考・判断」を行う主体。<br>提供されたコンテキスト（SubAgent, Memory, Skill）に基づいて最終回答を生成する。

    %% --- 1. 準備フェーズ ---
    rect rgb(235, 245, 255)
        note right of User: 【準備】定義・ツールのロード
        ClaudeCode->>SubAgent: 1. ロード：専門家の定義
        ClaudeCode->>MemoryMCP: 2. 接続：記憶領域の読込準備
        ClaudeCode->>Skill: 3. ロード：Skill定義
    end

    %% --- 2. 実行フェーズ ---
    rect rgb(255, 250, 240)
        note right of User: 【実行】検索結果を付与してAIへ

        User->>ClaudeCode: 4. 入力：「AWS接続コードを書いて」
        
        %% --- サブエージェント選定 ---
        ClaudeCode->>LLM: 5. 相談：担当領域の判定
        LLM-->>ClaudeCode: 6. 選択：サブエージェントA(クラウド領域)

        ClaudeCode->>SubAgent: 7. 開始：コンテキスト構築処理
        
        %% --- Memory MCPによる検索（LLMは関与しない） ---
        rect rgb(255, 245, 230)
            note right of SubAgent: AIに送る前に、システム側で<br>関連情報を検索しておく

            SubAgent->>MemoryMCP: 8. 検索：ベクトル検索や文字列検索を実行
            MemoryMCP-->>SubAgent: 9. 返却：検索結果「AWSキーは環境変数を利用」
            
            note right of SubAgent: 【コンテキスト結合】<br>「ユーザの指示」に<br>「検索されたルール」を合体
        end

        %% --- 結合済みコンテキストの送信 ---
        SubAgent->>LLM: 10. 送信：結合されたコンテキスト(指示+ルール)
        
        note right of LLM: ルール付きの指示書として読むため<br>自然と制約が守られる

        LLM-->>SubAgent: 11. 判断：Skill B(環境変数対応版)を採用

        rect rgb(245, 245, 245)
            SubAgent->>Skill: 12. 開始：Skillの実行
            Skill->>MCP: 13. 利用：コード作成・操作
            MCP-->>Skill: 14. 返却：実行結果
            Skill-->>SubAgent: 15. 完了：成果物
        end

        SubAgent->>ClaudeCode: 16. 報告：最終回答
    end

    ClaudeCode-->>User: 17. 表示：「環境変数対応済みコードです」